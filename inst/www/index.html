<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>TruthCoin Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/alertify.css">
    <link rel="stylesheet" href="css/main.css">
    <!--[if lt IE 9]><script src="js/html5shiv.js"></script><![endif]-->
  </head>
  <body>

    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h1>TruthCoin Demo</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2>Data</h2>
          <textarea id="data" rows="4" cols="50">
Label,QID1,QID2,QID3,QID4,QID5,QID6,QID7,QID8,QID9,QID10
Qtext,"In the United States, following the 2012 November / elections, was Barack Obama elected US President?","In the United States, following the 2012 November / elections, was Mitt Romney elected US President?","In the United States, following the 2012 November / elections, did the Democratic Party control 51...","In the United States, following the 2012 November / elections, did the Republican Party control 218...","In the United States, following the 2012 November / elections, how many seats in the House of Repre...","During the 2011-2012 United States football season, did the New / England Patriots (AFC) win the 20...","During the 2013-2014 United States football season, did the Denver / Broncos (AFC) win the 2014 Sup...","On June 27th, 2014, was the closing price of the Dow Jones / Industrial Average (INDEXDJX:.DJI) abo...","On June 27th, 2014, was the closing price of the SPDR Gold Trust / (ETF) (NYSEARCA:GLD) above 120?","On July 9th, 2014, what was the closing price of the Dow Jones / Industrial Average (INDEXDJX:.DJI,..."
Qtype,B,B,B,B,S,B,B,B,B,S
Min,0,0,0,0,0,0,0,0,0,8000
Max,1,1,1,1,538,1,1,1,1,20000
Voter 1,1,0,1,1,242,0,0,1,1,16985.61
Voter 2,0,0.5,0.5,,240,0,0,1,0,16985.61
Voter 3,1,0,1,1,242,0,0,1,1,
          </textarea>
          <h2>Code</h2>
          <textarea id="code" rows="4" cols="50">

lines <- '
Label,QID1,QID2,QID3,QID4,QID5,QID6,QID7,QID8,QID9,QID10
Qtext,"In the United States, following the 2012 November / elections, was Barack Obama elected US President?","In the United States, following the 2012 November / elections, was Mitt Romney elected US President?","In the United States, following the 2012 November / elections, did the Democratic Party control 51...","In the United States, following the 2012 November / elections, did the Republican Party control 218...","In the United States, following the 2012 November / elections, how many seats in the House of Repre...","During the 2011-2012 United States football season, did the New / England Patriots (AFC) win the 20...","During the 2013-2014 United States football season, did the Denver / Broncos (AFC) win the 2014 Sup...","On June 27th, 2014, was the closing price of the Dow Jones / Industrial Average (INDEXDJX:.DJI) abo...","On June 27th, 2014, was the closing price of the SPDR Gold Trust / (ETF) (NYSEARCA:GLD) above 120?","On July 9th, 2014, what was the closing price of the Dow Jones / Industrial Average (INDEXDJX:.DJI,..."
Qtype,B,B,B,B,S,B,B,B,B,S
Min,0,0,0,0,0,0,0,0,0,8000
Max,1,1,1,1,538,1,1,1,1,20000
Voter 1,1,0,1,1,242,0,0,1,1,16985.61
Voter 2,0,0.5,0.5,,240,0,0,1,0,16985.61
Voter 3,1,0,1,1,242,0,0,1,1,
'

print("Loading data..")
con <- textConnection(lines)
Data <- read.csv(con, stringsAsFactors= FALSE, row.names=1)
close(con)

print("Load Complete.")
print(" ")

## Get VoteMatrix ##
print("Getting Votes..")

ToMatrix <- function(DF) {
  RowNames <- row.names(DF)
  DFn <- data.frame ( lapply( DF, as.numeric) ) # make all observations numbers
  Matrix <- as.matrix(DFn,ncol = ncol(DF)) # save in matrix format
  row.names(Matrix) <- RowNames  # restore row names (lost during as.numeric)
  return(Matrix)
}

# Remove header info
VoteData <- Data[-1:-4,]
VoteMatrix <- ToMatrix(VoteData)

print(VoteMatrix)
print(" ")


## Rescale ##
print("Rescaling the Scaled Decisions..")

# Scaled claims must become range(0,1)

Scaled <- Data["Qtype",] == "S" # which of these are scaled at all?

# Rescale
ScaleData <- Data[c("Min", "Max"),Scaled] # get the scales from the 'Qtype' row, and nothing else
ScaleMatrix <- ToMatrix(ScaleData)


RescaledVoteMatrix <- VoteMatrix # declare destination data
for(i in 1:ncol(ScaleMatrix)) { # for each scaled decision
  
  ThisQ <- colnames(ScaleMatrix)[i]
  ThisColumn <- RescaledVoteMatrix[ , colnames(RescaledVoteMatrix)==ThisQ ] # match the right column
  RescaledColumn <- (ThisColumn - ScaleMatrix["Min",i]) / (ScaleMatrix["Max",i] - ScaleMatrix["Min",i])  # "rescale"
  
  RescaledVoteMatrix[ , colnames(RescaledVoteMatrix)==ThisQ ] <- RescaledColumn # Overwrite
}

print("Rescale Complete.")
print(" ")


## Do Computations ##

# Load what we need
print("Loading SVD Consensus Mechanism..")
source("consensus/ConsensusMechanism.r")

# I've already rescaled, but we still need to pass the boolean - must fix this.
ScaleData <- matrix( c( rep(FALSE,ncol(RescaledVoteMatrix)),
              rep(0,ncol(RescaledVoteMatrix)),
              rep(1,ncol(RescaledVoteMatrix))), 3, byrow=TRUE, dimnames=list(c("Scaled","Min","Max"),colnames(RescaledVoteMatrix)) )

ScaleData[1,] <- Scaled

# Get the Resuls
print("Calculating Results..")
SvdResults <- Factory(RescaledVoteMatrix,Scales = ScaleData)

print("Writing Output .csvs..")
print(" ")

#write.csv(SvdResults$Original, file="demo/output/OriginalVoteMatrix.csv")
#write.csv(SvdResults$Agents, file="demo/output/agents.csv")
#write.csv(SvdResults$Decisions, file="demo/output/decisions.csv")

print("Loading Plot Functions..")
source("consensus/PlotJ.r")

print("Making Plot..")
Plot <- PlotJ(RescaledVoteMatrix, Scales = ScaleData)


svg("demo/output/plot.svg",width = 8.5,height = 11)
Plot
dev.off()

print("Plot Complete.")

print("Done!")


          </textarea> 
        </div>
        <div class="col-md-6">        
          <button id="submitbutton" type="button" class="btn btn-primary">Call R</button>
          <h3>Return</h3>
          <pre class="pre-scrollable" id="return"></pre>
          <h3>Output</h3>
          <pre class="pre-scrollable" id="output"></pre>
        </div>
      </div>
    </div>
    
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/alertify.js"></script>
    <script src="js/opencpu-0.5.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>
